<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>کاتەکانی بانگ    | Athan Times </title>
    
    <meta name="theme-color" content="#020202">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/ramiqaladzay0/ramadan-challenge/450380601a15e12a80be482ee5149dd6dc52a0de/D5208D5D-BECD-4A90-9B8F-B7FC0679E5FA.jpeg">
    <link rel="icon" type="image/jpeg" href="https://raw.githubusercontent.com/ramiqaladzay0/ramadan-challenge/450380601a15e12a80be482ee5149dd6dc52a0de/D5208D5D-BECD-4A90-9B8F-B7FC0679E5FA.jpeg">
    
    <!-- بەستنەوەی manifest بۆ ئەوەی وەک ئەپ دابەزێت -->
    <link rel="manifest" href="/manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Sans+Arabic:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        :root {
            --primary: #fbbf24;
            --bg-dark: #020202;
            --card-bg: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.07);
        }

        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', 'Noto Sans Arabic', sans-serif;
            background-color: var(--bg-dark);
            color: #ffffff;
            overflow-x: hidden;
            line-height: 1.6;
        }

        .mesh-bg { background: radial-gradient(circle at 50% -20%, #1a1500 0%, #020202 80%); }

        .glass {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
        }

        .prayer-card-active {
            background: linear-gradient(145deg, rgba(251, 191, 36, 0.1) 0%, rgba(5, 5, 5, 0.4) 100%);
            border: 1px solid var(--primary);
        }

        .nav-item { transition: all 0.3s ease; opacity: 0.5; }
        .nav-item.active { opacity: 1; color: var(--primary); }

        .tab-content { display: none; opacity: 0; }
        .tab-content.active { display: flex; opacity: 1; animation: fadeIn 0.5s forwards; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .status-btn.muted { color: #ef4444; opacity: 0.8; }
        .status-btn.active { color: #22c55e; }

        #compass-disc { transition: transform 0.2s ease-out; }
    </style>
</head>
<body class="min-h-screen mesh-bg">

    <audio id="adhanAudio" src="https://raw.githubusercontent.com/ramiqaladzay0/ramadan-challenge/8b234542ee9a037b8b80909408fb7e791bf4b0dc/rekar-karim-Athan.mp3" preload="auto"></audio>

    <div id="loadingScreen" class="fixed inset-0 z-[999] bg-black flex flex-col items-center justify-center">
        <i data-lucide="loader-2" class="text-amber-500 w-10 h-10 animate-spin mb-4"></i>
        <h2 class="text-lg font-bold tracking-widest animate-pulse font-['Noto_Sans_Arabic']">کەمێک چاوەڕێ بکە ...</h2>
    </div>

    <div class="relative z-10 max-w-2xl mx-auto w-full px-6 pt-10 pb-32">
        
        <header class="flex justify-between items-center mb-10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl glass flex items-center justify-center text-amber-500">
                    <i data-lucide="mosque" class="w-6 h-6"></i>
                </div>
                <h1 class="text-xl font-black font-['Noto_Sans_Arabic']">کاتەکانی بانگ <span class="text-amber-500 text-xs">PRO</span></h1>
            </div>
            <button onclick="openModal('calendarModal')" class="w-11 h-11 rounded-xl glass flex items-center justify-center">
                <i data-lucide="calendar-days" class="w-5 h-5"></i>
            </button>
        </header>

        <div id="tab-prayers" class="tab-content active flex-col space-y-6">
            <section class="text-center py-10 glass rounded-[2.5rem] border-white/5 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500/50 to-transparent"></div>
                <h2 id="mainClock" class="text-7xl font-black tracking-tighter mb-2 tabular-nums">00:00</h2>
                <p id="kurdishDate" class="text-neutral-500 font-bold text-sm">---</p>
            </section>

            <section class="glass rounded-[2rem] p-6 flex justify-between items-center">
                <div>
                    <p class="text-[10px] font-black uppercase tracking-widest text-neutral-500 mb-1">بانگی داهاتوو</p>
                    <h3 id="nextPrayerName" class="text-3xl font-black">---</h3>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-black uppercase tracking-widest text-neutral-500 mb-1">ماوە بۆ بانگ</p>
                    <div id="countdown" class="text-2xl font-mono font-black text-amber-500">00:00:00</div>
                </div>
            </section>

            <div id="prayerList" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="tab-quran" class="tab-content flex-col space-y-4">
            <h2 class="text-3xl font-black mb-2">قورئانی پیرۆز</h2>
            <div id="surahList" class="grid grid-cols-1 gap-3 max-h-[70vh] overflow-y-auto no-scrollbar pb-10"></div>
        </div>

        <div id="tab-qibla" class="tab-content flex-col items-center justify-center py-10 space-y-10">
            <div class="text-center">
                <h2 class="text-4xl font-black mb-2">قیبلەنما</h2>
                <p class="text-neutral-500 text-sm">مۆبایلەکەت بە ڕووتەختی ڕابگرە</p>
            </div>
            <div class="relative w-72 h-72">
                <div id="compass-disc" class="w-full h-full relative">
                    <img src="https://cdn-icons-png.flaticon.com/512/2805/2805395.png" class="w-full h-full opacity-30" alt="Compass">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <div class="w-1.5 h-32 bg-amber-500 rounded-full shadow-[0_0_20px_#fbbf24]"></div>
                    </div>
                </div>
            </div>
            <button onclick="initCompass()" class="px-8 py-4 glass rounded-2xl text-xs font-black uppercase tracking-widest text-amber-500">چالاککردنی قیبلەنما</button>
        </div>

        <div id="tab-tasbih" class="tab-content flex-col items-center py-10 space-y-10">
            <h2 class="text-3xl font-black">تەسبیح</h2>
            <div onclick="incrementTasbih()" class="w-64 h-64 rounded-full glass border-4 border-amber-500/20 flex flex-col items-center justify-center cursor-pointer active:scale-95 transition-all">
                <span id="tasbihCount" class="text-8xl font-black tabular-nums">0</span>
                <span class="text-neutral-500 font-bold uppercase text-[10px] tracking-widest">Tap to Count</span>
            </div>
            <button onclick="resetTasbih()" class="flex items-center gap-2 text-neutral-500 hover:text-white transition-colors">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i> ریسێتکردنەوە
            </button>
        </div>

        <div id="tab-azkar" class="tab-content flex-col space-y-6">
            <div class="flex gap-2 p-1 glass rounded-2xl">
                <button onclick="switchAzkarSub('azkar')" id="btn-sub-azkar" class="flex-1 py-3 rounded-xl font-bold bg-amber-500 text-black">زیکرەکان</button>
                <button onclick="switchAzkarSub('names')" id="btn-sub-names" class="flex-1 py-3 rounded-xl font-bold text-neutral-400">ناوە جوانەکان</button>
            </div>
            <div id="sub-azkar" class="space-y-3 pb-20"></div>
            <div id="sub-names" class="hidden grid grid-cols-2 gap-3 pb-20"></div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 z-[100] glass border-t border-white/5 px-6 pt-4 pb-8">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <button onclick="switchTab('prayers')" class="nav-item flex flex-col items-center gap-1 active" id="nav-prayers"><i data-lucide="home" class="w-6 h-6"></i><span class="text-[8px] font-black uppercase">Home</span></button>
            <button onclick="switchTab('quran')" class="nav-item flex flex-col items-center gap-1" id="nav-quran"><i data-lucide="book-open" class="w-6 h-6"></i><span class="text-[8px] font-black uppercase">Quran</span></button>
            <button onclick="switchTab('qibla')" class="nav-item flex flex-col items-center gap-1" id="nav-qibla"><i data-lucide="compass" class="w-6 h-6"></i><span class="text-[8px] font-black uppercase">Qibla</span></button>
            <button onclick="switchTab('tasbih')" class="nav-item flex flex-col items-center gap-1" id="nav-tasbih"><i data-lucide="fingerprint" class="w-6 h-6"></i><span class="text-[8px] font-black uppercase">Dhikr</span></button>
            <button onclick="switchTab('azkar')" class="nav-item flex flex-col items-center gap-1" id="nav-azkar"><i data-lucide="heart" class="w-6 h-6"></i><span class="text-[8px] font-black uppercase">Names</span></button>
        </div>
    </nav>

    <div id="calendarModal" class="fixed inset-0 z-[300] bg-black/95 backdrop-blur-xl hidden p-6 overflow-y-auto no-scrollbar">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-2xl font-black">خشتەی مانگانە</h3>
            <button onclick="closeModal('calendarModal')" class="w-10 h-10 glass rounded-full flex items-center justify-center"><i data-lucide="x"></i></button>
        </div>
        <div id="monthlyCalendar" class="space-y-2"></div>
    </div>

    <div id="quranModal" class="fixed inset-0 z-[400] bg-black hidden flex flex-col">
        <div class="p-6 border-b border-white/5 flex justify-between items-center">
            <button onclick="closeModal('quranModal')" class="w-10 h-10 glass rounded-full flex items-center justify-center"><i data-lucide="chevron-right"></i></button>
            <h4 id="modalSurahName" class="text-xl font-black font-['Noto_Sans_Arabic']">---</h4>
            <div class="w-10"></div>
        </div>
        <div id="ayahContainer" class="flex-1 overflow-y-auto p-6 space-y-8 text-right font-['Noto_Sans_Arabic'] no-scrollbar"></div>
    </div>

    <script>
        const CONFIG = {
            lat: 36.1861,
            lng: 45.1211,
            offsets: { Fajr: 3, Sunrise: 0, Dhuhr: 6, Asr: 2, Maghrib: 8, Isha: 4 },
            names: { Fajr: 'بەیانی', Sunrise: 'خۆرھەڵات', Dhuhr: 'نیوەڕۆ', Asr: 'عەسر', Maghrib: 'مەغریب', Isha: 'عیشا' }
        };

        let state = {
            times: {},
            tasbih: parseInt(localStorage.getItem('tasbih_pro')) || 0,
            muted: JSON.parse(localStorage.getItem('muted_prayers')) || {},
            lastPlayed: '',
            wakeLock: null
        };

        const ALL_NAMES = [
            {ar: "الرَّحْمَنُ", ku: "بەخشندە"}, {ar: "الرَّحِيمُ", ku: "میهرەبان"}, {ar: "المَلِكُ", ku: "پاشا"}, {ar: "القُدُّوسُ", ku: "پاک"}, {ar: "السَّلَامُ", ku: "ئاشتی"}, {ar: "المُؤْمِنُ", ku: "بڕوادار"}, {ar: "المُهَيْمِنُ", ku: "پارێزەر"}, {ar: "العَزِيزُ", ku: "باڵادەست"}, {ar: "الجَبَّارُ", ku: "بەتوانا"}, {ar: "المُتَكَبِّرُ", ku: "گەورە"},
            {ar: "الخَالِقُ", ku: "دروستکەر"}, {ar: "البَارِئُ", ku: "بەدیهێنەر"}, {ar: "المُصَوِّرُ", ku: "شێوەکێش"}, {ar: "الغَفَّارُ", ku: "لێخۆشبوو"}, {ar: "القَهَّارُ", ku: "زەبردەست"}, {ar: "الوَهَّابُ", ku: "بەخشەر"}, {ar: "الرَّزَّاقُ", ku: "ڕۆزیدەر"}, {ar: "الفَتَّاحُ", ku: "کۆکەرەوە"}, {ar: "العَلِيمُ", ku: "زانا"}, {ar: "القَابِضُ", ku: "گرتار"},
            {ar: "البَاسِطُ", ku: "بڵاوکەرەوە"}, {ar: "الخَافِضُ", ku: "نزمکەرەوە"}, {ar: "الرَّافِعُ", ku: "بەرزکەرەوە"}, {ar: "المُعِزُّ", ku: "ڕێزدارکەر"}, {ar: "المُذِلُّ", ku: "سەرشۆڕکەر"}, {ar: "السَّمِيعُ", ku: "بیسەر"}, {ar: "البَصِيرُ", ku: "بینەر"}, {ar: "الحَكَمُ", ku: "دادوەر"}, {ar: "العَدْلُ", ku: "دادپەروەر"}, {ar: "اللَّطِيفُ", ku: "ناسک"},
            {ar: "الخَبِيرُ", ku: "ئاگادار"}, {ar: "الحَلِيمُ", ku: "نەرم"}, {ar: "العَظِيمُ", ku: "مەزن"}, {ar: "الغَفُورُ", ku: "لێخۆشبوو"}, {ar: "الشَّكُورُ", ku: "سوپاسگوزار"}, {ar: "العَلِيُّ", ku: "بەرز"}, {ar: "الكَبِيرُ", ku: "گەورە"}, {ar: "الحَفِيظُ", ku: "پارێزەر"}, {ar: "المُقِيتُ", ku: "ڕۆزیدەر"}, {ar: "الحَسِيبُ", ku: "حسابکەر"},
            {ar: "الجَلِيلُ", ku: "شکۆدار"}, {ar: "الكَرِيمُ", ku: "بەخشندە"}, {ar: "الرَّقِيبُ", ku: "چاودێر"}, {ar: "المُجِيبُ", ku: "وەڵامدەرەوە"}, {ar: "الوَاسِعُ", ku: "فراوان"}, {ar: "الحَكِيمُ", ku: "داناکەر"}, {ar: "الوَدُودُ", ku: "خۆشەویست"}, {ar: "المَجِيدُ", ku: "بەڕێز"}, {ar: "البَاعِثُ", ku: "زیندووکەرەوە"}, {ar: "الشَّهِيدُ", ku: "شایەت"},
            {ar: "الحَقُّ", ku: "ڕاستەقینە"}, {ar: "الوَكِيلُ", ku: "وەکیل"}, {ar: "القَوِيُّ", ku: "بەهێز"}, {ar: "المَتِينُ", ku: "پتەو"}, {ar: "الوَلِيُّ", ku: "سەرپەرشتیکەر"}, {ar: "الحَمِيدُ", ku: "سوپاسکراو"}, {ar: "المُحْصِي", ku: "ئامارکەر"}, {ar: "المُبْدِئُ", ku: "سەرەتاکەر"}, {ar: "المُمعِيدُ", ku: "گەڕێنەرەوە"}, {ar: "المُحْيِي", ku: "ژێنەرەوە"},
            {ar: "المُمِیتُ", ku: "مرێنەر"}, {ar: "الحَيُّ", ku: "زیندوو"}, {ar: "القَيُّومُ", ku: "ڕاگیرکەر"}, {ar: "الوَاجِدُ", ku: "دۆزەرەوە"}, {ar: "المَاجِدُ", ku: "بەرێز"}, {ar: "الوَاحِدُ", ku: "تاک"}, {ar: "الأَحَدُ", ku: "تەنیا"}, {ar: "الصَّمَدُ", ku: "بێ نیاز"}, {ar: "القَادِرُ", ku: "بەتوانا"}, {ar: "المُقْتَدِرُ", ku: "بەدەسەڵات"},
            {ar: "المُقَدِّمُ", ku: "پێشخەر"}, {ar: "المُؤَخِّرُ", ku: "پاشخەر"}, {ar: "الأَوَّلُ", ku: "یەکەم"}, {ar: "الآخِرُ", ku: "کۆتایی"}, {ar: "الظَّاهِرُ", ku: "ئاشکرا"}, {ar: "البَاطِنُ", ku: "پەنهان"}, {ar: "الوَالِي", ku: "سەرپەرشت"}, {ar: "المُتَعَالِي", ku: "بەرز و بڵند"}, {ar: "البَرُّ", ku: "چاکەکار"}, {ar: "التَّوَّابُ", ku: "تۆبەوەرگر"},
            {ar: "المُنْتَقِمُ", ku: "تۆڵەسێن"}, {ar: "العَفُوُّ", ku: "لێبوردە"}, {ar: "الرَّءُوفُ", ku: "دڵسۆز"}, {ar: "مَالِكُ المُلْكِ", ku: "خاوەنی پاشایەتی"}, {ar: "ذُو الجَلَالِ وَالإِكْرَامِ", ku: "خاوەن شکۆ"}, {ar: "المُقْسِطُ", ku: "دادپەروەر"}, {ar: "الجَامِعُ", ku: "کۆکەرەوە"}, {ar: "الغَنِيُّ", ku: "دەوڵەمەند"}, {ar: "المُغْنِي", ku: "دەوڵەمەندکەر"}, {ar: "المَانِعُ", ku: "رێگر"},
            {ar: "الضَّارُّ", ku: "زیانبەخش"}, {ar: "النَّافِعُ", ku: "سوودبەخش"}, {ar: "النُّورُ", ku: "ڕووناکی"}, {ar: "الهَادِي", ku: "ڕێ نیشاندەر"}, {ar: "البَدِيعُ", ku: "داهێنەر"}, {ar: "البَاقِي", ku: "نەمر"}, {ar: "الوَارِثُ", ku: "جێگرەوە"}, {ar: "الرَّشِيدُ", ku: "شارەزا"}, {ar: "الصَّبُورُ", ku: "ئارامگر"}
        ];

        async function init() {
            lucide.createIcons();
            
            // Register SW and Schedule Notifications
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    console.log('SW Registered');
                });
                
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data && event.data.type === 'PLAY_ATHAN') {
                        const audio = document.getElementById('adhanAudio');
                        audio.play().catch(e => console.log("Audio blocked", e));
                    }
                });
            }

            await fetchData();
            renderNames();
            renderAzkar();
            updateClock();
            setInterval(updateClock, 1000);
            
            if ("Notification" in window) {
                Notification.requestPermission().then(permission => {
                    if(permission === 'granted') scheduleAllPrayers();
                });
            }

            if ('wakeLock' in navigator) {
                try { state.wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            }

            document.getElementById('loadingScreen').style.display = 'none';
        }

        async function fetchData() {
            try {
                const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${CONFIG.lat}&longitude=${CONFIG.lng}&method=3`);
                const data = await res.json();
                processTimes(data.data.timings);
                fetchMonthly();
                fetchSurahs();
                scheduleAllPrayers(); // Schedule after fetching
            } catch (e) { console.error(e); }
        }

        function processTimes(raw) {
            Object.keys(CONFIG.names).forEach(key => {
                let [h, m] = raw[key].split(':').map(Number);
                let date = new Date();
                date.setHours(h, m + CONFIG.offsets[key], 0, 0);
                
                let display = "";
                if(['Asr', 'Maghrib', 'Isha'].includes(key)) {
                    let hour = date.getHours();
                    let ampm = hour >= 12 ? 'PM' : 'AM';
                    hour = hour % 12 || 12;
                    display = `${hour}:${date.getMinutes().toString().padStart(2, '0')} ${ampm}`;
                } else {
                    display = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                }
                
                state.times[key] = { display, raw: date };
            });
            renderPrayers();
        }

        function scheduleAllPrayers() {
            if (!("Notification" in window) || Notification.permission !== "granted") return;
            const now = new Date().getTime();

            Object.entries(state.times).forEach(([key, data]) => {
                if (key === 'Sunrise') return;
                const prayerTime = data.raw.getTime();
                const diff = prayerTime - now;

                if (diff > 0) {
                    navigator.serviceWorker.ready.then(registration => {
                        if (navigator.serviceWorker.controller) {
                            navigator.serviceWorker.controller.postMessage({
                                type: 'SCHEDULE_NOTIFICATION',
                                title: `کاتی بانگی ${CONFIG.names[key]}`,
                                body: `ئێستا کاتی بانگە لە شاری قەڵادزێ`,
                                delay: diff
                            });
                        }
                    });
                }
            });
        }

        function renderPrayers() {
            const container = document.getElementById('prayerList');
            container.innerHTML = '';
            Object.entries(CONFIG.names).forEach(([key, name]) => {
                const isMuted = state.muted[key];
                const div = document.createElement('div');
                div.id = `prayer-${key}`;
                div.className = "glass p-5 rounded-[1.8rem] flex justify-between items-center";
                div.innerHTML = `
                    <div class="flex items-center gap-4">
                        <button onclick="toggleMute('${key}')" class="status-btn ${isMuted ? 'muted' : 'active'}">
                            <i data-lucide="${isMuted ? 'bell-off' : 'bell'}" class="w-5 h-5"></i>
                        </button>
                        <div>
                            <p class="font-black text-lg">${name}</p>
                            <p class="text-[9px] text-neutral-500 font-bold uppercase tracking-widest">Asoi Qaladze</p>
                        </div>
                    </div>
                    <p class="text-xl font-black tabular-nums">${state.times[key].display}</p>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            document.getElementById('mainClock').innerText = timeString.slice(0,5);
            document.getElementById('kurdishDate').innerText = new Intl.DateTimeFormat('ku-IQ', { weekday: 'long', day: 'numeric', month: 'long' }).format(now);
            
            let next = null;
            let minDiff = Infinity;
            
            Object.entries(state.times).forEach(([key, data]) => {
                let diff = data.raw.getTime() - now.getTime();
                
                if (Math.abs(diff) < 1000 && state.lastPlayed !== key && !state.muted[key] && key !== 'Sunrise') {
                    playAthan(key);
                }

                if (diff < 0) diff += 86400000;
                if (diff < minDiff) {
                    minDiff = diff;
                    next = { key, name: CONFIG.names[key], diff };
                }
            });

            if (next) {
                document.getElementById('nextPrayerName').innerText = next.name;
                let s = Math.floor(next.diff / 1000);
                let h = Math.floor(s / 3600);
                let m = Math.floor((s % 3600) / 60);
                let sec = s % 60;
                document.getElementById('countdown').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
                
                document.querySelectorAll('[id^="prayer-"]').forEach(el => el.classList.remove('prayer-card-active'));
                document.getElementById(`prayer-${next.key}`)?.classList.add('prayer-card-active');
            }
        }

        function playAthan(key) {
            state.lastPlayed = key;
            const audio = document.getElementById('adhanAudio');
            audio.play().catch(e => console.log("Audio blocked: user interaction needed"));
            
            if (Notification.permission === "granted") {
                new Notification("کاتی بانگ", {
                    body: `ئێستا کاتی بانگی ${CONFIG.names[key]}ـە لە قەڵادزێ`,
                    vibrate: [200, 100, 200]
                });
            }
        }

        function initCompass() {
            if (window.DeviceOrientationEvent) {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission().then(ps => {
                        if (ps === 'granted') window.addEventListener('deviceorientation', handleOrientation, true);
                    });
                } else {
                    window.addEventListener('deviceorientation', handleOrientation, true);
                }
            }
        }

        function handleOrientation(event) {
            let heading = event.webkitCompassHeading || (360 - event.alpha);
            if(heading) {
                const qibla = 195; 
                document.getElementById('compass-disc').style.transform = `rotate(${-heading + qibla}deg)`;
            }
        }

        function incrementTasbih() {
            state.tasbih++;
            document.getElementById('tasbihCount').innerText = state.tasbih;
            localStorage.setItem('tasbih_pro', state.tasbih);
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function resetTasbih() {
            state.tasbih = 0;
            document.getElementById('tasbihCount').innerText = 0;
            localStorage.setItem('tasbih_pro', 0);
        }

        function toggleMute(key) {
            state.muted[key] = !state.muted[key];
            localStorage.setItem('muted_prayers', JSON.stringify(state.muted));
            renderPrayers();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            document.getElementById(`nav-${id}`).classList.add('active');
            lucide.createIcons();
        }

        function switchAzkarSub(type) {
            document.getElementById('sub-azkar').classList.toggle('hidden', type !== 'azkar');
            document.getElementById('sub-names').classList.toggle('hidden', type !== 'names');
            document.getElementById('btn-sub-azkar').className = type === 'azkar' ? 'flex-1 py-3 rounded-xl font-bold bg-amber-500 text-black' : 'flex-1 py-3 rounded-xl font-bold text-neutral-400';
            document.getElementById('btn-sub-names').className = type === 'names' ? 'flex-1 py-3 rounded-xl font-bold bg-amber-500 text-black' : 'flex-1 py-3 rounded-xl font-bold text-neutral-400';
        }

        function renderNames() {
            const container = document.getElementById('sub-names');
            ALL_NAMES.forEach(n => {
                const div = document.createElement('div');
                div.className = "glass p-4 rounded-2xl text-center";
                div.innerHTML = `<p class="text-xl font-black text-amber-500">${n.ar}</p><p class="text-[10px] text-neutral-500 font-bold font-['Noto_Sans_Arabic']">${n.ku}</p>`;
                container.appendChild(div);
            });
        }

        function renderAzkar() {
            const azkar = [
                {t: "سُبْحَانَ اللَّهِ", c: "١٠٠ جار"}, {t: "الْحَمْدُ لِلَّهِ", c: "١٠٠ جار"},
                {t: "لَا إِلَهَ إِلَّا اللَّهُ", c: "١٠٠ جار"}, {t: "اللَّهُ أَكْبەرُ", c: "١٠٠ جار"}
            ];
            const container = document.getElementById('sub-azkar');
            azkar.forEach(a => {
                const div = document.createElement('div');
                div.className = "glass p-5 rounded-2xl flex justify-between items-center";
                div.innerHTML = `<div><p class="text-lg font-bold">${a.t}</p><p class="text-xs text-amber-500 font-bold">${a.c}</p></div><i data-lucide="sparkles" class="w-4 h-4 text-neutral-600"></i>`;
                container.appendChild(div);
            });
        }

        async function fetchSurahs() {
            const res = await fetch(`https://api.alquran.cloud/v1/surah`);
            const data = await res.json();
            const container = document.getElementById('surahList');
            data.data.forEach(s => {
                const div = document.createElement('div');
                div.className = "glass p-4 rounded-2xl flex justify-between items-center cursor-pointer active:scale-95";
                div.onclick = () => openSurah(s.number);
                div.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center text-amber-500 font-black text-xs">${s.number}</div><div><p class="font-bold">${s.name}</p><p class="text-[9px] text-neutral-500">${s.numberOfAyahs} ئایەت</p></div></div><i data-lucide="chevron-left" class="w-4 h-4 text-neutral-700"></i>`;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        async function openSurah(num) {
            const modal = document.getElementById('quranModal');
            modal.classList.remove('hidden');
            const container = document.getElementById('ayahContainer');
            container.innerHTML = '<p class="text-center text-amber-500 animate-pulse">خەریکی وەرگرتنی ئایەتەکانە...</p>';
            const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}/ku.asan`);
            const data = await res.json();
            const resAr = await fetch(`https://api.alquran.cloud/v1/surah/${num}`);
            const dataAr = await resAr.json();
            document.getElementById('modalSurahName').innerText = data.data.name;
            container.innerHTML = '';
            dataAr.data.ayahs.forEach((a, i) => {
                const div = document.createElement('div');
                div.className = "space-y-2 border-r-2 border-amber-500/30 pr-4";
                div.innerHTML = `<p class="text-2xl leading-loose font-serif">${a.text}</p><p class="text-sm text-neutral-400 leading-relaxed font-['Noto_Sans_Arabic']">${data.data.ayahs[i].text}</p>`;
                container.appendChild(div);
            });
        }

        async function fetchMonthly() {
            const res = await fetch(`https://api.aladhan.com/v1/calendar?latitude=${CONFIG.lat}&longitude=${CONFIG.lng}&method=3`);
            const data = await res.json();
            const container = document.getElementById('monthlyCalendar');
            data.data.forEach(d => {
                const div = document.createElement('div');
                div.className = "glass p-4 rounded-xl flex justify-between items-center text-xs";
                div.innerHTML = `<span class="text-neutral-500 font-bold">${d.date.readable}</span><span class="font-black text-amber-500">${d.timings.Maghrib.split(' ')[0]}</span>`;
                container.appendChild(div);
            });
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        init();
    </script>
</body>
</html>
